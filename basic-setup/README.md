# RHACS Demo Basic Setup

This folder contains the core installation and configuration scripts for the RHACS demo environment.

## Overview

The `install.sh` script orchestrates the execution of all numbered setup scripts in sequence, providing a complete RHACS demo environment configuration.

**The install script automatically:**
- Installs `roxctl` CLI if not present
- Generates `ROX_API_TOKEN` using admin credentials
- Saves token to `~/.bashrc` for persistence
- Runs all configuration scripts in sequence

## Environment Variables

The scripts use the following environment variables:

- `ROX_CENTRAL_URL`: Full URL to RHACS Central (e.g., `https://central-stackrox.apps.cluster.com`)
- `ROX_PASSWORD`: Admin password for RHACS Central
- `ROX_API_TOKEN`: API token for authentication (auto-generated by install.sh)

**Important for `roxctl` usage:**

The `roxctl` CLI expects `host:port` format for the `-e` flag and defaults to `https://`. If your `ROX_CENTRAL_URL` includes `https://`, strip it before using with `roxctl`:

```bash
# Correct usage with roxctl
export ROX_CENTRAL_URL="https://central-stackrox.apps.cluster.com"
ROX_ENDPOINT="${ROX_CENTRAL_URL#https://}"  # Strips https:// prefix
roxctl -e "$ROX_ENDPOINT" --token "$ROX_API_TOKEN" central userpki list

# Alternative: use the helper function in the scripts
ROX_ENDPOINT=$(get_rox_endpoint)
roxctl -e "$ROX_ENDPOINT" --token "$ROX_API_TOKEN" central userpki list
```

For `curl` commands, use the full URL with `https://`:

```bash
# Correct usage with curl
curl -k -H "Authorization: Bearer $ROX_API_TOKEN" "$ROX_CENTRAL_URL/v1/auth/status"
```

## Installation

### Quick Start

From the **project root**, run:

```bash
./install.sh [PASSWORD]
```

Or from **within this folder**:

```bash
cd basic-setup
./install.sh [PASSWORD]
```

**Password options:**
- **Provide as argument**: `./install.sh myPassword123` (recommended)
- **Set as environment variable**: `export ROX_PASSWORD="myPassword123" && ./install.sh`
- **Auto-retrieve from cluster**: The script will attempt to fetch it from cluster secrets

**What happens automatically:**
1. âœ… Installs `roxctl` CLI (if not already present)
2. âœ… Generates `ROX_API_TOKEN` and saves to `~/.bashrc`
3. âœ… Runs setup scripts 01-06 in sequence
4. âœ… Configures complete RHACS demo environment
5. âŠ— Skips optional script 07 (custom TLS - requires manual execution)

## Setup Scripts

The following scripts are executed in numerical order:

| Script | Description | Requires Token | Auto-Run |
|--------|-------------|----------------|----------|
| `install.sh` | Main orchestrator - installs roxctl, generates token, runs scripts 01-06 | N/A | N/A |
| `01-verify-rhacs-install.sh` | Verifies RHACS installation, checks version, ensures TLS encryption | No | âœ“ |
| `02-compliance-operator-install.sh` | Installs Red Hat Compliance Operator for compliance scanning | No | âœ“ |
| `03-deploy-applications.sh` | Deploys demo applications from mfosterrox/demo-applications repo | No | âœ“ |
| `04-configure-rhacs-settings.sh` | Configures RHACS via API (metrics, retention, platform components) | **Yes** | âœ“ |
| `05-setup-co-scan-schedule.sh` | Creates automated compliance scan schedules | **Yes** | âœ“ |
| `06-trigger-compliance-scan.sh` | Triggers immediate compliance scans (optional) | **Yes** | âœ“ |
| `07-configure-custom-tls.sh` | Configures passthrough route and custom TLS certificate (requires --email) | No | **âœ— Skipped** |

**Note:** Script 07 is intentionally skipped by `install.sh` because it requires user-specific parameters (email address). Run it manually if you need custom TLS certificates.

## What Gets Configured

### RHACS Settings (Script 04)
- **Telemetry**: Enabled for product improvement
- **Metrics Collection**: 1-minute gathering period for:
  - Image vulnerabilities (CVE, deployment, namespace severity)
  - Policy violations (deployment, namespace severity)
  - Node vulnerabilities (component, CVE, node severity)
- **Retention Policies**:
  - 7-day alert retention
  - 30-day runtime retention
  - 90-day vulnerability request retention
  - 7-day report retention
- **Platform Components**: Red Hat layered products properly recognized
- **Vulnerability Exceptions**: Configurable expiry options (14, 30, 60, 90 days)

### Compliance Scanning (Script 05)
- Daily compliance scans at 12:00 PM
- Multiple compliance profiles:
  - ocp4-cis, ocp4-cis-node
  - ocp4-moderate, ocp4-moderate-node
  - ocp4-high, ocp4-high-node
  - ocp4-pci-dss, ocp4-pci-dss-node
  - ocp4-nerc-cip, ocp4-nerc-cip-node
  - ocp4-e8, ocp4-stig-node

### Custom TLS Configuration (Script 07) - Optional
This optional script configures Central with a custom TLS certificate and passthrough routing:
- **Operator-Based**: Installs Red Hat cert-manager Operator for OpenShift v1.18.1
- **Certificate Management**: Creates Let's Encrypt certificates via cert-manager
- **Route Configuration**: Changes Central route from reencrypt to passthrough termination
- **Automatic Renewal**: Certificates are automatically renewed by cert-manager (15 days before expiry)
- **Production Ready**: Supports both Let's Encrypt production and staging environments

**What it does:**
1. Verifies Red Hat cert-manager Operator is installed (exits if not found)
2. Creates a Let's Encrypt ClusterIssuer (production or staging)
3. Generates a Certificate resource for Central's route hostname
4. Configures Central deployment to use the custom certificate
5. Changes route termination from reencrypt/edge to passthrough
6. Restarts Central to apply the new TLS configuration

**Usage:**
```bash
# Production certificates (recommended)
./07-configure-custom-tls.sh --email your@email.com

# Testing with Let's Encrypt staging (for development/testing)
./07-configure-custom-tls.sh --email your@email.com --staging
```

**Requirements:**
- Cluster-admin access
- **Red Hat cert-manager Operator must be pre-installed** (stable-v1.18 or later)
- Central must be accessible from the internet (for Let's Encrypt HTTP-01 challenge)
- Valid email address for Let's Encrypt registration

**Note:** This script is optional and should be run after the main installation if you need custom certificates instead of OpenShift-generated certificates. The passthrough route allows Central to serve its own TLS certificate directly.

**ðŸ“– For detailed information**, see [CUSTOM-TLS-REFERENCE.md](./CUSTOM-TLS-REFERENCE.md) which includes:
- Architecture diagrams
- Detailed troubleshooting guide
- Certificate renewal procedures
- Rollback instructions
- Let's Encrypt rate limits and best practices

## Requirements

### Cluster Access
- Must be logged into OpenShift cluster via `oc login`
- Requires cluster-admin or equivalent permissions
- RHACS must be already installed (Central and Scanner pods running)

### Required Tools
- `oc` CLI (OpenShift command-line tool)
- `jq` (JSON processor)
- `curl` (for API calls)
- Internet connectivity (for downloading roxctl)

### Environment Variables

The install script checks for required variables in this order:
1. Command-line arguments (highest priority)
2. Current environment variables
3. Variables in `~/.bashrc`
4. Auto-detection from cluster

#### Required
- `ROX_PASSWORD` - RHACS admin password
  - Can be passed as argument: `./install.sh <PASSWORD>`
  - Can be set as env var: `export ROX_PASSWORD="..."`
  - Will be auto-retrieved from cluster if not provided
- `ROX_CENTRAL_URL` - RHACS Central URL
  - Auto-detected from cluster route if not provided

#### Optional
- `RHACS_NAMESPACE` - RHACS namespace (default: `stackrox`)
- `RHACS_ROUTE_NAME` - Route name (default: `central`)
- `RHACS_VERSION` - Target version (default: `4.9.2`)

#### Auto-Generated
- `ROX_API_TOKEN` - API token for RHACS operations
  - Automatically generated during installation
  - Saved to `~/.bashrc` for persistence
  - Used by scripts 04, 05, and 06

## Individual Script Execution

You can run individual scripts for testing or troubleshooting:

```bash
# First: Ensure environment is set up
source ~/.bashrc  # Load ROX_API_TOKEN if previously generated

# Verify RHACS (no token needed)
bash basic-setup/01-verify-rhacs-install.sh

# Install Compliance Operator (no token needed)
bash basic-setup/02-compliance-operator-install.sh

# Deploy applications (no token needed)
bash basic-setup/03-deploy-applications.sh

# Configure RHACS settings (REQUIRES ROX_API_TOKEN)
bash basic-setup/04-configure-rhacs-settings.sh

# Setup compliance scanning (REQUIRES ROX_API_TOKEN)
bash basic-setup/05-setup-co-scan-schedule.sh

# Trigger compliance scan (REQUIRES ROX_API_TOKEN)
bash basic-setup/06-trigger-compliance-scan.sh
```

**Important Notes:**
- Individual scripts assume RHACS is already installed and accessible
- Scripts 04, 05, and 06 **require** `ROX_API_TOKEN` to be set
- Run the main `install.sh` once to generate and save the token
- Or manually generate: see "API Token Generation" section below

## Troubleshooting

### Missing Variables
If scripts fail due to missing variables:

```bash
# Add to ~/.bashrc
export ROX_CENTRAL_URL="https://central-stackrox.apps.your-cluster.com"
export ROX_PASSWORD="your-admin-password"
export RHACS_NAMESPACE="stackrox"

# Reload
source ~/.bashrc
```

### RHACS Not Ready
If RHACS is not ready:

```bash
# Check RHACS status
oc get deployment central -n stackrox
oc get pods -n stackrox

# Wait for Central to be ready
oc wait --for=condition=available --timeout=300s deployment/central -n stackrox
```

### API Token Generation Fails
If token generation fails:

```bash
# Verify password is correct
oc get secret central-htpasswd -n stackrox -o jsonpath='{.data.password}' | base64 -d

# Test API access manually
curl -k -u "admin:YOUR_PASSWORD" \
  https://your-central-url/v1/apitokens/generate \
  -X POST -H "Content-Type: application/json" \
  -d '{"name":"test","roles":["Admin"]}'
```

### Manual API Token Generation
If automatic generation doesn't work, generate manually:

```bash
# Get password
ROX_PASSWORD=$(oc get secret central-htpasswd -n stackrox -o jsonpath='{.data.password}' | base64 -d)

# Get Central URL
CENTRAL_URL=$(oc get route central -n stackrox -o jsonpath='{.spec.host}')

# Generate token
export ROX_API_TOKEN=$(curl -k -X POST -u "admin:${ROX_PASSWORD}" \
  -H "Content-Type: application/json" \
  "https://${CENTRAL_URL}/v1/apitokens/generate" \
  -d '{"name":"manual-setup","roles":["Admin"]}' | jq -r '.token')

# Save to ~/.bashrc
echo "export ROX_API_TOKEN=\"${ROX_API_TOKEN}\"" >> ~/.bashrc

# Verify
echo "Token saved: ${#ROX_API_TOKEN} characters"
```

### roxctl Not Found After Installation
If roxctl is not in PATH after installation:

```bash
# Reload your shell configuration
source ~/.bashrc

# Or add manually
export PATH="$HOME/.local/bin:$PATH"

# Verify
roxctl version
```

## Related Documentation

- **Main README**: `../README.adoc` - Project overview and getting started
- **Monitoring Setup**: `../monitoring/README.md` - Detailed monitoring configuration
- **Dashboard Setup**: `../DASHBOARD_SETUP_GUIDE.md` - OpenShift dashboard setup guide

## Monitoring

For monitoring and dashboard setup, see the root-level script:
```bash
# From project root
./setup-openshift-dashboard.sh
```

This is separate from the basic setup and configures:
- Cluster Observability Operator
- Perses dashboards in OpenShift console
- Prometheus scraping with proper authentication

See `../DASHBOARD_SETUP_GUIDE.md` for details.
