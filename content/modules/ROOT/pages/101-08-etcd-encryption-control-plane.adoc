= Lab: Etcd Encryption at Rest & Basic Control Plane Hardening
:labid: LAB-101-08
:cis-summary: "Enable etcd encryption at rest and implement basic control plane security hardening."
:mitre-summary: "Prevents data exposure through encryption at rest and reduces control plane attack surface."
:toc:
:sectnums:
:icons: font

== Skill
Learn how to enable etcd encryption at rest to protect sensitive data stored in the cluster's key-value store, and implement basic control plane hardening measures to reduce the attack surface of your OpenShift cluster.

== Objective

* Understand etcd encryption at rest requirements
* Enable encryption for Kubernetes secrets
* Verify encryption status
* Implement basic control plane hardening
* Understand encryption key management

== Why it Matters
Etcd stores all cluster data including secrets, configmaps, and other sensitive information. Without encryption at rest, anyone with access to etcd storage can read this data. Enabling encryption protects against unauthorized access to stored secrets and meets compliance requirements for data protection.

== What it Solves

* Unencrypted secret storage
* Compliance requirements
* Data breach prevention
* Control plane security
* Key management

== Understanding the Attack Surface
[cols="1,2,2",options="header"]
|===
|Area | Risk If Unencrypted | Mitigation
|Etcd Storage | Secret exposure | Encryption at rest
|Backup Files | Data leakage | Encrypted backups
|Control Plane | Unauthorized access | Hardening measures
|Key Management | Key compromise | Secure key storage
|===

== Concepts: Etcd Encryption at Rest and Control Plane

*Etcd* is the cluster's key-value store; it holds all API objects, including Secrets, ConfigMaps, and other sensitive data. By default, etcd may store data in plaintext (or base64 only for Secrets). *Encryption at rest* means the API server encrypts resources before writing them to etcd and decrypts them when reading, so that anyone with access to etcd storage cannot read secret data. OpenShift can enable this via an encryption configuration that specifies which resources to encrypt and how. Enabling or changing encryption typically requires cluster-admin and may involve API server restarts or node coordination.

The *control plane* consists of the API server, etcd, scheduler, controller manager, and the nodes that run them. Hardening includes restricting access to control plane nodes, ensuring API server and etcd are configured securely, and using encryption and audit logging. This lab focuses on *checking* current encryption status and control plane health rather than changing encryption (which is usually done at install or via cluster configuration).

== How to Try It

You will inspect the cluster's encryption configuration and API server encryption type, then review control plane namespaces (API server and etcd pods) and node layout. No resources are created or modified; this is an observational lab. Cluster-admin (or read access to cluster-scoped resources) is required to view encryption config and API server spec.

=== Use case 1: Check current encryption status
The cluster may expose an `EncryptionConfig` or similar resource that describes what is encrypted at rest. Inspect it to see whether encryption is enabled and for which resources.

*Procedure*

. Retrieve the cluster encryption configuration (cluster-scoped resource):

[source,sh]
----
oc get encryptionconfig cluster -o yaml
----

*What to look for:* The spec may list resources (e.g., `secrets`) and the encryption type (e.g., `aesgcm` or identity for no encryption). If the resource does not exist or shows identity/no encryption, secrets may be stored in etcd without encryption. If it shows a non-identity type and includes `secrets`, encryption at rest is enabled for those resources.

NOTE: On some OpenShift versions the resource name or API may differ (e.g., `apiserver.config.openshift.io` or operator-managed encryption). If the command fails, check the documentation for your version. Enabling etcd encryption usually requires cluster-admin and is done during installation or via the cluster-wide encryption configuration.

=== Use case 2: Verify API server encryption configuration
The API server's spec may indicate the encryption type in use. This complements the encryption config and confirms what the API server is applying.

*Procedure*

. Print the API server's encryption type (cluster-scoped):

[source,sh]
----
oc get apiserver cluster -o jsonpath='{.spec.encryption.type}' ; echo
----

*Expected:* A value such as `aesgcm` or similar if encryption is enabled, or empty/identity if not. Document what you see for your cluster so you know the current state.

IMPORTANT: Enabling or changing etcd encryption requires cluster-admin and may require API server restarts or rolling node updates. It is typically done during cluster installation or through managed cluster configuration (e.g., install config or operator). Do not change encryption in a production cluster without a maintenance window and backup plan.

=== Use case 3: Basic control plane hardening check
Review control plane nodes and the pods running in the API server and etcd namespaces. Healthy, running pods and a clear view of control plane nodes are part of basic hardening awareness.

*Procedure*

. List nodes with wide output to see roles and status:

[source,sh]
----
oc get nodes -o wide
----

*What to look for:* Control plane (master) nodes and worker nodes. Ensure control plane nodes are Ready and that you know which nodes run etcd and the API server.

. List pods in the API server namespace:

[source,sh]
----
oc get pods -n openshift-kube-apiserver
----

*Expected:* Running API server pods (e.g., one per control plane node). These serve the cluster API and apply encryption when writing to etcd if encryption is enabled.

. List pods in the etcd namespace:

[source,sh]
----
oc get pods -n openshift-etcd
----

*Expected:* Running etcd pods. Etcd holds the encrypted (or plaintext) data; access to these pods and their storage should be restricted as part of control plane hardening.

TIP: Use `oc get nodes -l node-role.kubernetes.io/master` (or the equivalent label for your version) to list only control plane nodes. Restrict SSH and network access to these nodes and ensure they receive security updates.

=== Use case 4: Cleanup

No cleanup is needed for this lab. You only inspected cluster state; no projects or test resources were created.

== What Would You Do?

You checked the cluster's encryption configuration and API server encryption type and reviewed control plane pods and nodes. In your own environment, consider:

* If encryption at rest is not enabled, how would you plan to enable it (e.g., at next install or via managed cluster config) and what downtime or coordination is acceptable?
* How would you integrate an external KMS for key management so encryption keys are not stored only on the cluster?
* How would you regularly verify control plane node and pod health and restrict access to etcd and API server components?

== Solutions / Controls

* Etcd encryption at rest
* KMS integration for key management
* Control plane node hardening
* API server security configuration
* Audit logging

== Summary

You inspected the cluster's encryption configuration and API server encryption type to see whether etcd encryption at rest is enabled, and you reviewed control plane nodes and the openshift-kube-apiserver and openshift-etcd namespaces. Enabling or changing encryption is typically done at install or via cluster configuration and may require restarts; this lab focused on observation and awareness. Encryption at rest plus control plane hardening reduce the risk of secret exposure and unauthorized access to cluster data.

== Summary Table
[cols="1,2,2",options="header"]
|===
|Control | Purpose | Benefit
|Etcd Encryption | Data protection | Compliance & security
|KMS Integration | Key management | Secure key storage
|Node Hardening | Reduced attack surface | Fewer vulnerabilities
|API Security | Access control | Authorized access only
|===

== FAQs
When should encryption be enabled?:: During cluster installation or as part of security hardening.
Does encryption impact performance?:: Minimal impact; encryption is hardware-accelerated.
Can I enable encryption on existing clusters?:: Yes, but requires careful planning and may require downtime.

== Closing Story
Encryption at rest is like a safe for your cluster's secretsâ€”essential for protecting sensitive data.

== Next Step Ideas

* Integrate with external KMS
* Review control plane node security
* Implement encryption key rotation
